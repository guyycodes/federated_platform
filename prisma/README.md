# Federated Audit Platform - Database Schema

This Prisma schema defines the data model for a federated audit platform that supports modular, sandboxed audit procedures with multi-tier access plans.

## Overview

The platform enables organizations to conduct various compliance audits (FISMA, SOC 2, ISO 27001, etc.) using AI-powered modules that run in isolated environments. Each module generates audit workpapers and findings based on the specific framework requirements.

## Key Features

### 1. **Multi-Tier Plan System**
- **Commercial**: Standard compliance modules (SOC 2, ISO 27001)
- **Enterprise**: Advanced features with custom configurations
- **Federal**: Government-specific modules (FISMA, FedRAMP, NIST frameworks)

### 2. **Federated Module Architecture**
- Each audit module runs in its own sandboxed environment
- Modules are containerized (Docker/K8s) for isolation
- Resource allocation per module (CPU, memory, storage)
- Module-specific API endpoints for integration

### 3. **Audit Frameworks Supported**
- FISMA (Federal Information Security Management Act)
- SOC 1 & SOC 2 (Type I & II)
- ISO 27001/27017/27018
- NIST CSF, 800-53, 800-171
- HIPAA, PCI-DSS, GDPR, CCPA
- FedRAMP, CMMC

## Core Entities

### Organizations & Users
- **Organization**: Client companies/agencies using the platform
- **User**: Individual auditors, managers, and reviewers within organizations
- **Account**: Subscription management with plan tiers and billing

### Modules & Access
- **Module**: Audit procedure applications (FISMA audit, risk assessment, etc.)
- **ModuleAccess**: User-level permissions for modules
- **AccountModuleAccess**: Organization-level module subscriptions
- **ModuleEnvironment**: Sandboxed runtime environments for modules

### Audit Execution
- **AuditProject**: Instance of an audit being performed
- **Workpaper**: Audit documentation generated by modules or manually
- **Finding**: Issues identified during audits
- **WorkpaperTemplate**: Reusable templates provided by modules

### Supporting Entities
- **ActivityLog**: Comprehensive audit trail
- **UsageRecord**: Resource consumption tracking for billing
- **Invoice**: Billing and payment tracking

## Module Sandboxing

Each module runs in an isolated environment with:
- Dedicated container/pod
- Resource limits (CPU, memory, storage)
- Network isolation
- Secure secret management
- Health monitoring

## Database Setup

```bash
# Install dependencies
npm install

# Set up environment variables
cp .env.example .env
# Edit .env with your PostgreSQL connection strings

# Run migrations
npx prisma migrate dev

# Seed the database with sample data
npx prisma db seed

# Generate Prisma Client
npx prisma generate
```

## Environment Variables

```env
DATABASE_URL="postgresql://user:password@localhost:5432/audit_platform"
DIRECT_URL="postgresql://user:password@localhost:5432/audit_platform"
```

## Key Relationships

1. **Organization → Accounts → Module Access**
   - Organizations can have multiple accounts (different divisions/plans)
   - Each account has access to specific modules based on plan tier

2. **Projects → Workpapers → Findings**
   - Audit projects use modules to generate workpapers
   - Findings are linked to workpapers and projects

3. **Modules → Environments**
   - Each active module instance has its own sandboxed environment
   - Environments are provisioned per project

## Security Considerations

- User authentication via external providers (Clerk)
- Role-based access control (RBAC)
- Data isolation between organizations
- Encrypted storage for sensitive audit data
- Comprehensive activity logging

## Extensibility

The schema is designed to be extensible:
- JSON fields for flexible configurations
- Module templates can define custom workpaper structures
- Feature flags stored as JSON for easy updates
- Custom audit frameworks can be added via the enum